# Mise configuration for Codex Linux build environment

[tools]
rust = "1.93.0"
node = "22"
jq = "latest"

[env]
CARGO_BUILD_JOBS = "4"
CARGO_TARGET_DIR = "{{env.HOME}}/.cache/codex-linux-port/build"
NODE_ENV = "production"
ELECTRON_SKIP_BINARY_DOWNLOAD = "1"
CODEX_VERSION = "260208.1016"
CODEX_DMG_URL = "https://persistent.oaistatic.com/codex-app-prod/Codex.dmg"
WORKDIR = "{{env.HOME}}/.cache/codex-linux-port"
INSTALL_DIR = "{{env.HOME}}/.local/bin"

[tasks.deps]
description = "Verify all dependencies"
run = "echo '=== Dependencies ===' && rustc --version && cargo --version && node --version && npm --version && git --version && which 7z"

[tasks.install-system-deps]
description = "Install 7z and build tools"
run = """
if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update -qq && sudo apt-get install -y p7zip-full build-essential libssl-dev pkg-config
elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y p7zip p7zip-plugins gcc gcc-c++ openssl-devel pkgconfig
elif command -v pacman >/dev/null 2>&1; then
    sudo pacman -S --noconfirm p7zip base-devel openssl pkgconf
elif command -v brew >/dev/null 2>&1; then
    brew install p7zip
else
    echo 'âš ï¸ Could not auto-install p7zip. Please install it manually.'
fi
"""

[tasks.download]
description = "Download Codex macOS DMG"
run = """
mkdir -p {{env.WORKDIR}}
cd {{env.WORKDIR}}
if [ ! -f Codex.dmg ]; then
    echo 'Downloading Codex {{env.CODEX_VERSION}}...'
    curl -L -o Codex.dmg '{{env.CODEX_DMG_URL}}' || wget -O Codex.dmg '{{env.CODEX_DMG_URL}}'
else
    echo 'Using cached Codex.dmg'
fi
ls -lh Codex.dmg
"""

[tasks.extract]
description = "Extract DMG and ASAR"
depends = ["download"]
run = """
cd {{env.WORKDIR}}
rm -rf extracted app_unpacked
mkdir -p extracted
echo 'Extracting DMG...'
7z x Codex.dmg -oextracted/ -y
ASAR_PATH=$(find extracted -name 'app.asar' -type f | head -1)
echo "ASAR: $ASAR_PATH"
npm install --prefix {{env.WORKDIR}}/.npm-local asar
{{env.WORKDIR}}/.npm-local/node_modules/.bin/asar extract "$ASAR_PATH" app_unpacked/
ls -la app_unpacked/
"""

[tasks.clone-codex]
description = "Clone openai/codex repo"
run = """
cd {{env.WORKDIR}}
if [ ! -d codex-src ]; then
    git clone --depth 1 https://github.com/openai/codex.git codex-src
else
    cd codex-src && git pull --depth 1
fi
"""

[tasks.build-rust]
description = "Build Rust CLI (10-15 min)"
depends = ["clone-codex"]
run = """
cd {{env.WORKDIR}}/codex-src/codex-rs
echo 'Building codex CLI...'
cargo build --release --bin codex
ls -lh target/release/codex
file target/release/codex
"""

[tasks.build-sandbox]
description = "Build Linux sandbox helper"
depends = ["clone-codex"]
run = """
cd {{env.WORKDIR}}/codex-src/codex-rs
cargo build --release --bin codex-linux-sandbox || echo 'Sandbox build failed (optional)'
ls -lh target/release/codex-linux-sandbox 2>/dev/null || true
"""

[tasks.rebuild-native]
description = "Rebuild native Node modules"
depends = ["extract"]
run = """
cd {{env.WORKDIR}}/app_unpacked
if [ -f node_modules/better-sqlite3/build/Release/better_sqlite3.node ]; then
    npm rebuild better-sqlite3 || true
fi
if [ -f node_modules/node-pty/build/Release/pty.node ]; then
    npm rebuild node-pty || true
fi
"""

[tasks.assemble]
description = "Assemble Linux app bundle"
depends = ["build-rust", "build-sandbox", "rebuild-native"]
run = """
cd {{env.WORKDIR}}/app_unpacked
rm -f native/sparkle.node
rm -rf node_modules/electron-liquid-glass
cp {{env.WORKDIR}}/codex-src/codex-rs/target/release/codex resources/codex
chmod +x resources/codex
cp {{env.WORKDIR}}/codex-src/codex-rs/target/release/codex-linux-sandbox resources/ 2>/dev/null || true
cp {{config_root}}/codex-linux.sh.template codex-linux.sh
chmod +x codex-linux.sh
echo "âœ… Assembled at {{env.WORKDIR}}/app_unpacked/"
"""

[tasks.install-cli]
description = "Install CLI to PATH"
depends = ["assemble"]
run = """
mkdir -p {{env.INSTALL_DIR}}
cp {{env.WORKDIR}}/app_unpacked/resources/codex {{env.INSTALL_DIR}}/
chmod +x {{env.INSTALL_DIR}}/codex
echo "Installed to {{env.INSTALL_DIR}}/codex"
{{env.INSTALL_DIR}}/codex --version 2>/dev/null || true
"""

[tasks.desktop-entry]
description = "Create desktop entry"
depends = ["assemble"]
run = """
mkdir -p {{env.HOME}}/.local/share/applications
cat > {{env.HOME}}/.local/share/applications/codex.desktop << 'EOF'
[Desktop Entry]
Name=Codex
Comment=OpenAI Codex AI coding assistant
Exec={{env.WORKDIR}}/app_unpacked/codex-linux.sh
Icon={{env.WORKDIR}}/app_unpacked/webview/assets/logo-BtOb2qkB.png
Type=Application
Categories=Development;IDE;
Terminal=false
EOF
chmod +x {{env.HOME}}/.local/share/applications/codex.desktop
echo "Desktop entry created"
"""

[tasks.full-build]
description = "Complete build"
depends = ["install-system-deps", "deps", "download", "extract", "clone-codex", "build-rust", "build-sandbox", "rebuild-native", "assemble", "install-cli", "desktop-entry"]
run = """
echo ''
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo '                âœ… BUILD COMPLETE!'
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
echo ''
echo 'ðŸ“¦ App:  {{env.WORKDIR}}/app_unpacked/'
echo 'ðŸ”§ CLI: {{env.INSTALL_DIR}}/codex'
echo 'ðŸ–¥ï¸  GUI: {{env.HOME}}/.local/share/applications/codex.desktop'
echo ''
echo 'Usage: codex --help | codex login | codex-linux.sh'
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
"""

[tasks.clean]
description = "Clean build cache"
run = "rm -rf {{env.WORKDIR}} && echo 'Cleaned {{env.WORKDIR}}'"

[settings]
jobs = 4
