# Unified Codex Build and Release Workflow
#
# Builds both Windows installer and Linux AppImage in parallel
# Creates a combined GitHub release with both artifacts
#
# Trigger: Push packaging changes, or run manually.
# CLI binaries are downloaded from the official openai/codex GitHub releases.

name: Build and Release Codex

on:
  workflow_dispatch:
    inputs:
      cli_tag:
        description: "openai/codex release tag to download CLI binaries from (e.g. rust-v0.102.0-alpha.7)"
        required: false
        default: "rust-v0.102.0-alpha.7"
  push:
    paths:
      - ".github/workflows/build-release.yml"
      - "versions.json"
      - "installer/windows/codex.nsi"
      - "infra/vm/guest/windows-build.ps1"

env:
  CODEX_DMG_URL: "https://persistent.oaistatic.com/codex-app-prod/Codex.dmg"
  CODEX_CLI_TAG: "rust-v0.102.0-alpha.7"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # SHARED: Extract and prepare app resources from DMG (runs once)
  # ═══════════════════════════════════════════════════════════════════════════
  extract:
    runs-on: ubuntu-latest
    outputs:
      electron_version: ${{ steps.get-versions.outputs.electron_version }}
      app_version: ${{ steps.get-versions.outputs.app_version }}
      cli_tag: ${{ steps.cli-tag.outputs.cli_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Download CLI binaries (Linux + Windows)
        id: cli-tag
        run: |
          set -euo pipefail
          cli_tag="${{ inputs.cli_tag }}"
          if [ -z "$cli_tag" ]; then
            cli_tag="$CODEX_CLI_TAG"
          fi
          echo "cli_tag=$cli_tag" >> "$GITHUB_OUTPUT"
          echo "Using CLI tag: $cli_tag"

          mkdir -p cli-binaries _cli_tmp/linux _cli_tmp/win

          linux_asset="codex-x86_64-unknown-linux-gnu.tar.gz"
          win_asset="codex-x86_64-pc-windows-msvc.exe.zip"

          curl -sL --fail -o "_cli_tmp/$linux_asset" \
            "https://github.com/openai/codex/releases/download/$cli_tag/$linux_asset"
          tar -xzf "_cli_tmp/$linux_asset" -C _cli_tmp/linux
          mv _cli_tmp/linux/codex-x86_64-unknown-linux-gnu cli-binaries/codex
          chmod +x cli-binaries/codex

          curl -sL --fail -o "_cli_tmp/$win_asset" \
            "https://github.com/openai/codex/releases/download/$cli_tag/$win_asset"
          unzip -q "_cli_tmp/$win_asset" -d _cli_tmp/win
          mv _cli_tmp/win/codex-x86_64-pc-windows-msvc.exe cli-binaries/codex.exe

          echo "✅ Downloaded CLI binaries:"
          file cli-binaries/codex
          file cli-binaries/codex.exe

      - name: Upload CLI binaries
        uses: actions/upload-artifact@v4
        with:
          name: cli-binaries
          path: cli-binaries
          retention-days: 30

      - name: Install extraction tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full dmg2img icnsutils imagemagick unzip
          npm install -g @electron/asar

      - name: Download and extract DMG
        run: |
          curl -L --fail -o Codex.dmg "$CODEX_DMG_URL"
          dmg2img Codex.dmg Codex.img
          mkdir -p extracted
          7z x Codex.img -oextracted/ -y >/dev/null || true

      - name: Extract and convert Codex icon
        run: |
          ICNS_PATH=$(find extracted -name "*.icns" -type f | head -1)
          if [ -n "$ICNS_PATH" ]; then
            echo "Found icon: $ICNS_PATH"
            cp "$ICNS_PATH" codex-icon.icns
            
            # Convert to ICO (256x256 max for Windows)
            if command -v icns2png &> /dev/null; then
              icns2png -x codex-icon.icns
              TARGET_PNG=$(ls codex-icon_*.png 2>/dev/null | grep -E "256x256" | head -1)
              if [ -z "$TARGET_PNG" ]; then
                TARGET_PNG=$(ls -S codex-icon_*.png 2>/dev/null | head -1)
              fi
              if [ -n "$TARGET_PNG" ]; then
                # Create a multi-resolution ICO so Windows can pick the best size
                convert "$TARGET_PNG" -define icon:auto-resize=256,128,64,48,32,16 codex-icon.ico
                echo "✅ Created codex-icon.ico"
              fi
            fi
          fi

      - name: Extract ASAR
        run: |
          ASAR_PATH=$(find extracted -name app.asar -type f | head -1)
          if [ -z "$ASAR_PATH" ]; then
            echo "❌ Could not locate app.asar" >&2
            exit 1
          fi
          asar extract "$ASAR_PATH" app_unpacked/

      - name: Get versions
        id: get-versions
        run: |
          cd app_unpacked
          electron_ver=$(node -p "require('./package.json').devDependencies?.electron || ''" 2>/dev/null || true)
          electron_ver="${electron_ver#^}"
          app_ver=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
          echo "electron_version=$electron_ver" >> "$GITHUB_OUTPUT"
          echo "app_version=$app_ver" >> "$GITHUB_OUTPUT"
          echo "Electron: $electron_ver, App: $app_ver"

      - name: Verify .vite directory
        run: |
          if [ ! -d "app_unpacked/.vite" ] || [ ! -f "app_unpacked/.vite/build/main.js" ]; then
            echo "❌ .vite directory missing from extracted ASAR!" >&2
            exit 1
          fi
          echo "✅ .vite directory verified"

      - name: Prepare shared artifacts
        run: |
          # Tar the app bundle to preserve hidden .vite directory
          tar -czf app-unpacked.tar.gz app_unpacked/
          ls -lh app-unpacked.tar.gz

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: app-unpacked
          path: app-unpacked.tar.gz
          retention-days: 1

      - name: Upload icon
        uses: actions/upload-artifact@v4
        with:
          name: codex-icon
          path: codex-icon.ico
          retention-days: 1
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════════════════
  # WINDOWS: Build Windows installer
  # ═══════════════════════════════════════════════════════════════════════════
  build-windows:
    needs: extract
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Extract app bundle
        shell: bash
        run: |
          tar -xzf app-unpacked/app-unpacked.tar.gz
          ls -la app_unpacked/
          ls -la app_unpacked/.vite/ 2>/dev/null || echo "⚠️  .vite not found"

      - name: Rebuild native modules for Windows
        shell: bash
        run: |
          electron_ver="${{ needs.extract.outputs.electron_version }}"
          
          # Get module versions
          sqlite_ver=$(node -p "require('./app_unpacked/node_modules/better-sqlite3/package.json').version")
          pty_ver=$(node -p "require('./app_unpacked/node_modules/node-pty/package.json').version")
          echo "Rebuilding better-sqlite3=$sqlite_ver node-pty=$pty_ver for Electron $electron_ver"
          
          # Reinstall with full source
          mkdir -p _native_src
          cd _native_src
          npm init -y
          npm install "better-sqlite3@$sqlite_ver" "node-pty@$pty_ver" --ignore-scripts
          cd ..
          
          # Replace modules
          rm -rf app_unpacked/node_modules/better-sqlite3
          rm -rf app_unpacked/node_modules/node-pty
          cp -r _native_src/node_modules/better-sqlite3 app_unpacked/node_modules/
          cp -r _native_src/node_modules/node-pty app_unpacked/node_modules/
          rm -rf _native_src
          
          # Rebuild
          npm install -g @electron/rebuild
          electron-rebuild \
            --version "$electron_ver" \
            --arch x64 \
            --module-dir ./app_unpacked \
            --only better-sqlite3,node-pty \
            --build-from-source

      - name: Download Electron and assemble
        shell: bash
        run: |
          electron_ver="${{ needs.extract.outputs.electron_version }}"
          echo "Downloading Electron v${electron_ver} win32-x64..."
          curl -sL --fail -o electron.zip \
            "https://github.com/electron/electron/releases/download/v${electron_ver}/electron-v${electron_ver}-win32-x64.zip"
          
          mkdir -p electron-dist
          unzip -q electron.zip -d electron-dist
          rm -f electron-dist/resources/default_app.asar
          mv app_unpacked electron-dist/resources/app
          mv electron-dist/electron.exe electron-dist/Codex.exe

          # Patch the EXE icon so the titlebar/taskbar icon is Codex (not Electron).
          # This affects the running app window icon; shortcuts alone are not enough.
          if [ -f "codex-icon/codex-icon.ico" ]; then
            echo "Patching Codex.exe icon with rcedit..."
            RCEDIT_URL="$(python - <<'PY'
import json, re, urllib.request
data = json.load(urllib.request.urlopen("https://api.github.com/repos/electron/rcedit/releases/latest"))
for a in data.get("assets", []):
    name = a.get("name", "")
    url = a.get("browser_download_url", "")
    if not url:
        continue
    if re.search(r"(?:^|/)rcedit.*x64.*\\.exe$", name, re.IGNORECASE):
        print(url)
        raise SystemExit(0)
    if re.search(r"(?:^|/)rcedit.*\\.exe$", name, re.IGNORECASE) and "x64" in name.lower():
        print(url)
        raise SystemExit(0)
print("")
PY
)"
            if [ -z "$RCEDIT_URL" ]; then
              echo "⚠️  Could not resolve rcedit download URL; skipping EXE icon patch"
            else
              curl -sL --fail -o rcedit.exe "$RCEDIT_URL"
              ./rcedit.exe "electron-dist/Codex.exe" --set-icon "codex-icon/codex-icon.ico"
              rm -f rcedit.exe
            fi
          else
            echo "⚠️  codex-icon.ico missing; skipping EXE icon patch"
          fi
          
          # Copy Windows CLI binary
          mkdir -p \
            electron-dist/resources/app \
            electron-dist/resources/app/resources \
            electron-dist/resources/app/resources/bin \
            electron-dist/resources/app/bin \
            electron-dist/resources \
            electron-dist/resources/bin
          cp "$GITHUB_WORKSPACE/cli-binaries/codex.exe" electron-dist/resources/app/resources/codex.exe
          cp electron-dist/resources/app/resources/codex.exe electron-dist/resources/app/resources/bin/codex.exe
          cp electron-dist/resources/app/resources/codex.exe electron-dist/resources/app/codex.exe
          cp electron-dist/resources/app/resources/codex.exe electron-dist/resources/app/bin/codex.exe
          cp electron-dist/resources/app/resources/codex.exe electron-dist/resources/codex.exe
          cp electron-dist/resources/app/resources/codex.exe electron-dist/resources/bin/codex.exe
          
          for cli_path in \
            electron-dist/resources/app/resources/codex.exe \
            electron-dist/resources/app/resources/bin/codex.exe \
            electron-dist/resources/app/codex.exe \
            electron-dist/resources/app/bin/codex.exe \
            electron-dist/resources/codex.exe \
            electron-dist/resources/bin/codex.exe; do
            if [ ! -f "$cli_path" ]; then
              echo "❌ codex executable not found at $cli_path" >&2
              exit 1
            fi
          done
          
          # Copy icon if available
          if [ -f "codex-icon/codex-icon.ico" ]; then
            cp codex-icon/codex-icon.ico electron-dist/resources/app/resources/codex-icon.ico
          fi
          
          ls -lh electron-dist/Codex.exe

      - name: Verify native modules
        shell: bash
        run: |
          APP=electron-dist/resources/app
          file "$APP/resources/codex.exe" | grep -i "PE32"
          find "$APP/node_modules/better-sqlite3" -name "*.node" -exec file {} \; | head -1
          find "$APP/node_modules/node-pty" -name "*.node" -exec file {} \; | head -1

      - name: Build NSIS installer
        shell: bash
        run: |
          app_ver="${{ needs.extract.outputs.app_version }}"
          mv electron-dist codex-windows-x64
          
          ICON_DEFINE=""
          if [ -f "codex-windows-x64/resources/app/resources/codex-icon.ico" ]; then
            ICON_DEFINE="-DAPP_ICON=resources\app\resources\codex-icon.ico"
          fi
          
          MAKENSIS="/c/Program Files (x86)/NSIS/makensis.exe"
          if [ ! -f "$MAKENSIS" ]; then
            choco install nsis -y --no-progress
            MAKENSIS="/c/Program Files (x86)/NSIS/makensis.exe"
          fi
          
          SOURCE_ABS="$(cygpath -w "$(pwd)/codex-windows-x64")"
          "$MAKENSIS" \
            -DAPP_VERSION="$app_ver" \
            -DSOURCE_DIR="$SOURCE_ABS" \
            $ICON_DEFINE \
            installer/windows/codex.nsi
          
          mv installer/windows/Codex-Setup-*.exe Codex-Setup-Windows-x64.exe
          ls -lh Codex-Setup-Windows-x64.exe

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: Codex-Setup-Windows-x64.exe
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # LINUX: Build Linux AppImage
  # ═══════════════════════════════════════════════════════════════════════════
  build-linux:
    needs: extract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file
          npm install -g @electron/asar

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Extract app bundle
        run: |
          tar -xzf app-unpacked/app-unpacked.tar.gz
          ls -la app_unpacked/
          ls -la app_unpacked/.vite/

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/share/codex AppDir/usr/bin
          cp -a app_unpacked/. AppDir/usr/share/codex/
          
          # Copy Linux CLI binary
          mkdir -p AppDir/usr/share/codex/resources AppDir/usr/share/codex/resources/bin
          cp "$GITHUB_WORKSPACE/cli-binaries/codex" AppDir/usr/share/codex/resources/codex
          cp AppDir/usr/share/codex/resources/codex AppDir/usr/share/codex/resources/bin/codex
          chmod +x AppDir/usr/share/codex/resources/codex
          chmod +x AppDir/usr/share/codex/resources/bin/codex
          
          # Copy sandbox if available
          if [ -f "$GITHUB_WORKSPACE/cli-binaries/codex-linux-sandbox" ]; then
            cp "$GITHUB_WORKSPACE/cli-binaries/codex-linux-sandbox" AppDir/usr/share/codex/resources/
            chmod +x AppDir/usr/share/codex/resources/codex-linux-sandbox
          fi
          
          # Create symlinks
          ln -sf ../share/codex/resources/codex AppDir/usr/bin/codex
          
          # AppRun script
          cat > AppDir/AppRun <<'EOF'
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          APP_DIR="${HERE}/usr/share/codex"
          export PATH="${APP_DIR}/resources:${APP_DIR}/resources/bin:${PATH}"
          export CODEX_CLI_PATH="${APP_DIR}/resources/bin/codex"
          
          if [ "${1:-}" = "--cli" ]; then
            shift
            exec "${CODEX_CLI_PATH}" "$@"
          fi
          
          if command -v electron >/dev/null 2>&1; then
            exec electron "${APP_DIR}" "$@"
          fi
          
          echo "Electron not found on host."
          echo "Run CLI mode with: ./Codex.AppImage --cli --help"
          exit 1
          EOF
          chmod +x AppDir/AppRun
          
          # Desktop file
          cat > AppDir/codex.desktop <<'EOF'
          [Desktop Entry]
          Name=Codex
          GenericName=AI Coding Assistant
          Comment=OpenAI Codex - AI-powered coding assistant
          Exec=AppRun
          Icon=codex
          Terminal=false
          Type=Application
          Categories=Development;IDE;TextEditor;
          Keywords=codex;ai;code;editor;openai;
          EOF
          
          # Icon
          icon_src=$(ls AppDir/usr/share/codex/webview/assets/app-*.png 2>/dev/null | head -1 || true)
          if [ -z "$icon_src" ]; then
            icon_src=$(ls AppDir/usr/share/codex/webview/assets/logo-*.png 2>/dev/null | head -1 || true)
          fi
          if [ -n "$icon_src" ]; then
            cp "$icon_src" AppDir/codex.png
          fi
          
          ls -la AppDir/

      - name: Download appimagetool
        run: |
          curl -fsSL -o appimagetool \
            "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool AppDir Codex-x86_64.AppImage
          ls -lh Codex-x86_64.AppImage
          file Codex-x86_64.AppImage

      - name: Test AppImage CLI
        run: |
          chmod +x Codex-x86_64.AppImage
          ./Codex-x86_64.AppImage --cli --version || true

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: Codex-x86_64.AppImage
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════
  # RELEASE: Create combined GitHub release with both artifacts
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "Artifacts downloaded:"
          find artifacts -type f -ls

      - name: Get CLI versions
        id: versions
        run: |
          # Try to extract versions from binaries
          win_cli_ver=$(file artifacts/cli-binaries/codex.exe 2>/dev/null | grep -oP '\d+\.\d+\.\d+[^)]*' | head -1 || echo "unknown")
          linux_cli_ver=$(strings artifacts/cli-binaries/codex 2>/dev/null | grep -oP '\d+\.\d+\.\d+[^ ]*' | head -1 || echo "unknown")
          echo "windows_cli=$win_cli_ver" >> "$GITHUB_OUTPUT"
          echo "linux_cli=$linux_cli_ver" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-installer/*.exe
            artifacts/linux-appimage/*.AppImage
          name: "Codex ${{ github.ref_name }}"
          body: |
            ## Unofficial community build notice
            This repository is a community-maintained project and is not affiliated with, endorsed by, or sponsored by OpenAI, ChatGPT, or Codex.
            It is a hobby/independent packaging effort with independently produced installers.

            ## Codex Release ${{ github.ref_name }}
            
            ### Downloads
            - **Windows**: `Codex-Setup-Windows-x64.exe` - NSIS installer
            - **Linux**: `Codex-x86_64.AppImage` - AppImage (make executable and run)
            
            ### Usage
            **Windows:**
            ```powershell
            # Install
            .\Codex-Setup-Windows-x64.exe
            
            # Run
            Codex
            ```
            
            **Linux:**
            ```bash
            # Make executable
            chmod +x Codex-x86_64.AppImage
            
            # Run GUI
            ./Codex-x86_64.AppImage
            
            # Run CLI
            ./Codex-x86_64.AppImage --cli --help
            ```
            
            ### Versions
            - App: ${{ needs.extract.outputs.app_version }}
            - CLI tag: ${{ needs.extract.outputs.cli_tag }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup intermediate artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            app-unpacked
            codex-icon
